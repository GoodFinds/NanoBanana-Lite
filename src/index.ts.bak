import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { htmlContent } from './html-content'

const app = new Hono()

// CORS 配置
app.use('*', cors({
  origin: ['*'],
  allowHeaders: ['Content-Type', 'Authorization', 'HTTP-Referer', 'X-Title'],
  allowMethods: ['GET', 'POST', 'OPTIONS'],
}))

// 主页 - 返回 HTML 内容

// 静态CSS文件路由
app.get("/styles.css", async (c) => {
  try {
    const fs = await import("fs/promises")
    const path = await import("path")
    const cssPath = path.join(process.cwd(), "src", "styles.css")
    const cssContent = await fs.readFile(cssPath, "utf-8")
    return c.text(cssContent, 200, {
      "Content-Type": "text/css",
      "Cache-Control": "public, max-age=3600"
    })
  } catch (error) {
    return c.text("/* CSS file not found */", 404)
  }
})
app.get('/', async (c) => {
  try {
    // 将 HTML 中的 API 端点替换为我们的代理端点
    const modifiedHtml = htmlContent.replace(/https:\/\/api\.nano-img\.com/g, '/api/chat')
    return c.html(modifiedHtml)
  } catch (error) {
    return c.text(`Error loading page: ${error.message}`, 500)
  }
})

// API 代理端点 - 转发到实际的 AI API
app.post('/api/chat', async (c) => {
  try {
    const body = await c.req.json()
    const authHeader = c.req.header('Authorization')
    const refererHeader = c.req.header('HTTP-Referer')
    const titleHeader = c.req.header('X-Title')
    
    // 目标 API 端点
    const targetUrl = 'https://api.nano-img.com'
    
    console.log('Proxying request to:', targetUrl)
    console.log('Request body:', JSON.stringify(body, null, 2))
    
    const response = await fetch(targetUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authHeader || '',
        'HTTP-Referer': refererHeader || '',
        'X-Title': titleHeader || 'nano banana H5',
      },
      body: JSON.stringify(body)
    })
    
    const responseText = await response.text()
    console.log('Response status:', response.status)
    console.log('Response body:', responseText.slice(0, 200) + '...')
    
    // 返回原始响应
    return new Response(responseText, {
      status: response.status,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type, Authorization, HTTP-Referer, X-Title',
      }
    })
  } catch (error) {
    console.error('API proxy error:', error)
    return c.json({
      error: {
        message: `API请求失败: ${error.message}`
      }
    }, 500)
  }
})

// 健康检查
app.get('/health', (c) => {
  return c.json({ 
    status: 'ok', 
    timestamp: new Date().toISOString(),
    version: '1.0.0',
    service: 'nano-img-hono'
  })
})

// API 信息端点
app.get('/api/info', (c) => {
  return c.json({
    name: 'nano banana AI 抽卡',
    description: 'AI 图像生成抽卡游戏',
    endpoints: {
      '/': 'Web 界面',
      '/api/chat': 'AI 图像生成 API 代理',
      '/health': '健康检查',
      '/api/info': 'API 信息'
    }
  })
})

// 404 处理
app.notFound((c) => {
  return c.json({ error: 'Not Found', path: c.req.path }, 404)
})

export default app
